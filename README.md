# Mise

A CLI orchestrator for long-running coding agents. Mise breaks large tasks into structured plans, executes them through AI coding agents (currently Claude Code), and verifies results with backpressure checks -- all with deterministic, non-AI orchestration logic.

## Prerequisites

- **Node.js 18+**
- **git 2.15+** (worktree support for parallel execution)
- **Claude CLI** ([Claude Code](https://docs.anthropic.com/en/docs/claude-code))

## Installation

```bash
npm install -g mise-cli
```

## Quickstart

```bash
# Initialize in your project
mise init

# Plan tasks from a prompt
mise prep "add user authentication with JWT"

# Execute all tasks
mise loop
```

Or do it all at once:

```bash
mise "add user authentication with JWT"
```

## Commands

| Command | Description |
|---------|-------------|
| `mise init` | Initialize mise in the current project. Detects language, framework, and backpressure commands. |
| `mise prep [prompt]` | Plan tasks from a prompt or PRD file. Generates a task board via the AI engine. |
| `mise run` | Execute the next ready task. |
| `mise loop` | Execute all ready tasks in sequence (or parallel if configured). |
| `mise status` | Show the current board status. |
| `mise log` | Show the progress log with cost tracking. |
| `mise "prompt"` | Shorthand: runs `prep` then `loop`. |
| `mise feedback "msg"` | Submit feedback as a GitHub issue. Requires `gh` CLI. |

## Flags

| Flag | Description |
|------|-------------|
| `-y, --yes` | Auto-approve plans without prompting |
| `--verbose` | Verbose output (show engine output) |
| `--prd <file>` | Path to a PRD file for planning |
| `--task <id>` | Run a specific task (with `mise run`) |
| `--retries <n>` | Max retries on backpressure failure |
| `--skip-failures` | Skip failed tasks and continue (with `mise loop`) |
| `--max-retries <n>` | Max retries per task (with `mise loop`) |
| `--no-color` | Disable terminal colors |

## Configuration

After `mise init`, edit `.mise/station.yaml`:

```yaml
project:
  name: my-project
  language: typescript
  framework: react
  package_manager: npm

backpressure:
  test: npm run test
  lint: npm run lint
  build: npm run build
  typecheck: npx tsc --noEmit

rules:
  - "Use functional components"
  - "Write tests for new features"

boundaries:
  - "Do not modify the auth module"

engine:
  name: claude
  model: sonnet
  max_budget_usd: 5.00
  allowed_tools: []

mode:
  attended: true          # Ask for approval before executing
  parallel: "off"         # "off", "auto", or a number
  max_parallel: 4
  max_retries: 2
  skip_failures: false

runtime:
  heartbeat_interval_ms: 30000
  stale_threshold_ms: 120000
```

## `.mise/` Directory Structure

```
.mise/
  station.yaml          # Project configuration
  board.yaml            # Task board (generated by prep)
  brief.md              # Current status brief (regenerated after each task)
  toc.md                # Table of contents for the project
  toc.meta.yaml         # TOC fingerprints for drift detection
  progress.log          # Append-only execution log with cost tracking
  run.lock              # Lock file to prevent concurrent runs
  status/               # Per-task status files
    <task-id>.yaml
  evidence/             # Per-task evidence files (written by agent)
    <task-id>.md
  clarifications/       # Per-task clarification Q&A
    <task-id>.md
  logs/                 # Per-task backpressure logs
    <task-id>/
      test.log
      lint.log
```

## How It Works

1. **`mise init`** detects your project's language, framework, package manager, and backpressure commands. Creates the `.mise/` directory.

2. **`mise prep`** sends your prompt (or PRD) to the AI engine along with a table of contents and project rules. The engine returns a structured task board with groups, dependencies, and acceptance criteria.

3. **`mise loop`** executes tasks in dependency order:
   - Checks readiness (env vars, services)
   - Sends a focused prompt for each task
   - Commits changes with `mise(<task-id>): <title>` format
   - Runs backpressure checks (test, lint, build, typecheck)
   - Retries on failure, up to the configured limit
   - Regenerates the brief after each completion
   - Supports parallel execution via git worktrees

4. **Crash recovery**: If mise crashes, the lock file's heartbeat goes stale. The next run detects this, resets in-progress tasks to pending, and continues.

## Parallel Execution

Set `mode.parallel` to `"auto"` or a number in `station.yaml`. Mise will:

- Select tasks from the lowest incomplete group
- Only parallelize tasks marked `parallel_safe: true`
- Verify `owned_paths` don't overlap between concurrent tasks
- Execute each task in a git worktree
- Merge branches back in deterministic order
- Fall back to sequential on merge conflicts

## License

MIT
